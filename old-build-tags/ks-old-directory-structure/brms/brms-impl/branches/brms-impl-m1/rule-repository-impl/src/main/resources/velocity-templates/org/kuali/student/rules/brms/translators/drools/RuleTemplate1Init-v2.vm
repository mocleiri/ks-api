##
## Copyright 2007 The Kuali Foundation
##
## Licensed under the Educational Community License, Version 1.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
## http://www.opensource.org/licenses/ecl1.php
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##

## A generic initialization rule template
## Generics need Java 1.5 or greater - Must set drools.dialect.java.compiler=ECLIPSE

#macro (dataType $comparisonDataType)
    #if($comparisonDataType == "java.lang.String")
        $comparisonDataType value${key} = "$rhs";
    #else
        $comparisonDataType value${key} = new $comparisonDataType("$rhs");
    #end
#end

rule "${ruleName}"
    no-loop true
    lock-on-active true

    when 
        container : FactContainer( anchor == "${anchor}", state == FactContainer.State.INIT, propositionMap : propositionMap, prop : propositionContainer, factMap : factMap )
        //Only run rule when: currentDate >= effectiveStartTime AND currentDate < effectiveEndTime
        CurrentDateTime( currentDateAsLong >= $effectiveStartTime && currentDateAsLong < $effectiveEndTime )
    then
        Logger logger = LoggerFactory.getLogger(org.kuali.student.rules.translators.RuleSetTranslator.class);

        if (logger.isDebugEnabled()) {
            logger.debug("id="+container.getId());
            logger.debug("anchor="+container.getAnchor());
            logger.debug("factMap="+factMap);
        }

        prop.setFunctionalRuleString("$functionString");
        #foreach( $key in $propositionMap.keySet() ) 
       		#set( $proposition = $propositionMap.get($key) )
       		#set( $rhs = $proposition.RightHandSide.ExpectedValue )
            #set( $comparisonDataType = $proposition.ComparisonDataType )
       		#set( $operator = $proposition.ComparisonOperatorType )
    		#set( $yvf = $proposition.LeftHandSide.YieldValueFunction )
            ##set( $yvfDataType = $proposition.LeftHandSide.YieldValueFunction.YieldValueFunctionDataType )

            String uuid${key} = "${key}-${uuid}";
            RulePropositionDTO ruleProposition${key} = (RulePropositionDTO) propositionMap.get("${key}");
            YieldValueFunctionDTO yvf${key} = ruleProposition${key}.getLeftHandSide().getYieldValueFunction();

            #if ( $yvf.YieldValueFunctionType == "SIMPLECOMPARABLE" )
                #dataType($comparisonDataType)
                YVFSimpleComparableProposition yvfProposition${key} = new YVFSimpleComparableProposition(
                    uuid${key}, "${key}", ComparisonOperator.${operator}, value${key}, 
                    yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
            #elseif ( $yvf.YieldValueFunctionType == "SUBSET" )
                YVFSubsetProposition yvfProposition${key} = new YVFSubsetProposition(
                    uuid${key}, "${key}", yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
       		#elseif ( $yvf.YieldValueFunctionType == "INTERSECTION" )
                YVFIntersectionProposition yvfProposition${key} = new YVFIntersectionProposition(
                    uuid${key}, "${key}", ComparisonOperator.${operator}, new Integer($rhs), 
                    yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
            #elseif ( $proposition.LeftHandSide.YieldValueFunction.YieldValueFunctionType == "SUM" )
                #dataType($comparisonDataType)
                YVFSumProposition yvfProposition${key} = new YVFSumProposition(
                    uuid${key}, "${key}", ComparisonOperator.${operator}, value${key}, 
                    yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
            #elseif ( $proposition.LeftHandSide.YieldValueFunction.YieldValueFunctionType == "AVERAGE" )
                #dataType($comparisonDataType)
                YVFAverageProposition yvfProposition${key} = new YVFAverageProposition(
                    uuid${key}, "${key}", ComparisonOperator.${operator}, value${key}, 
                    yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
            #elseif ( $proposition.LeftHandSide.YieldValueFunction.YieldValueFunctionType == "MIN" )
                #dataType($comparisonDataType)
                YVFMinProposition yvfProposition${key} = new YVFMinProposition(
                    uuid${key}, "${key}", ComparisonOperator.${operator}, value${key}, 
                    yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
            #elseif ( $proposition.LeftHandSide.YieldValueFunction.YieldValueFunctionType == "MAX" )
                #dataType($comparisonDataType)
                YVFMaxProposition yvfProposition${key} = new YVFMaxProposition(
                    uuid${key}, "${key}", ComparisonOperator.${operator}, value${key}, 
                    yvf${key}, factMap );
                yvfProposition${key}.apply();
                prop.addProposition(yvfProposition${key}.getProposition());
                insert(yvfProposition${key}.getProposition());
            #end
        #end

        container.setState(FactContainer.State.DONE);
        update(container);
end